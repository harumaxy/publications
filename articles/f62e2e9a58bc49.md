---
title: "Godot ã¨ Phoenix Channels ã§ WebSocket ã—ãŸ"
emoji: "ğŸ¤–"
type: "tech"
topics:
  - "elixir"
  - "websocket"
  - "godot"
  - "phoenix"
published: true
published_at: "2021-04-13 01:09"
---

# WebSocket ã§ Online Multipayer
ã‚²ãƒ¼ãƒ åˆ¶ä½œã‚’ã—ã¦ã„ã‚‹ã¨ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ã‚’å®Ÿè£…ã—ãŸã„ã¨æ€ã†ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ç‰¹ã«ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã¨ã™ã”ãé¢ç™½ã„ã¨æ€ã„ã¾ã™ã€‚

ãã“ã§ã€ WebSocket ã‚’ä½¿ã£ãŸã‚µãƒ¼ãƒãƒ¼ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€šä¿¡ã‚’å®Ÿè£…ã—ãŸã®ã§æ‰‹é †ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://youtu.be/o31bJ168bsM


# å‰ç½®ã : Elixir & Phoenix, ãã—ã¦ Phoenix Channels

- Elixirã¯æ‹¡å¼µæ€§ã¨ä¿å®ˆæ€§ã®é«˜ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ãƒ‡ã‚¶ã‚¤ãƒ³ã•ã‚ŒãŸã€å‹•çš„ã§é–¢æ•°å‹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚

**Elixir** ã¯ ErlangVM (BEAM) ã§å‹•ãã€å‹•çš„å‹ä»˜ã‘ã®é–¢æ•°å‹è¨€èªã§ã™ã€‚

æ™®æ®µã€ä»•äº‹ã§ã¯é™çš„å‹ä»˜ã‘ã®é–¢æ•°å‹è¨€èªã‚’ä½¿ã£ã¦ã‚‹ã®ã§ã€å‹ã®ã‚µãƒãƒ¼ãƒˆã¨ã‹è£œå®ŒãŒå¼±ãã¦å¿ƒã‚‚ã¨ãªã„ã“ã¨ã‚‚ã‚ã‚‹ã‘ã‚Œã©ã€ dialyzer ã§é™çš„è§£æã—ã¦å‹ã‚¨ãƒ©ãƒ¼ã¨ã‹æŒ‡æ‘˜ã—ã¦ãã‚Œã‚‹ã®ã§ã¨ã‚Šã‚ãˆãšã¯å®‰å¿ƒã—ã¦æ›¸ã‘ã‚‹è¨€èªã ã¨æ€ã„ã¾ã™ã€‚

ãªã«ã‚ˆã‚Šã€Ericssonç¤¾ã«ã‚ˆã‚Šé€šä¿¡åˆ†é‡ã§30å¹´ä»¥ä¸Šä½¿ç”¨ã•ã‚Œç¶šã‘ã‚‹ **Battle Tested** (ã“ã®ãƒ•ãƒ¬ãƒ¼ã‚ºå¥½ã) ãª **ErlangVM** ã§å‹•ããƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã•ã‚Œã€è»½é‡ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã‚‹é«˜ã„ä¸¦åˆ—æ€§ãŒã‚ã‚Šã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’æ„è­˜ã—ãŸè¨­è¨ˆã‚’ã‚‚ã¤ã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

ãã—ã¦ Elixir ã«ã¯ **Phoenix** ã¨ã„ã†ã‚­ãƒ©ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå­˜åœ¨ã—ã¾ã™ã€‚

ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ (Ruby ã«ãŠã‘ã‚‹ Ruby on Rails ã¨ã„ãˆã‚‹å­˜åœ¨) ã§ã€Web Application ã¯ã“ã‚Œä½¿ã£ã¨ã‘ã°ã¨ã‚Šã‚ãˆãšä½•ã§ã‚‚ä½œã‚Œã‚‹ã¨ã„ã†å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã¦ãã‚Œã‚‹ã®ã§ã€å®‰å¿ƒã—ã¦ä½¿ãˆã¾ã™ã­ï¼

ã•ã‚‰ã«ã•ã‚‰ã«ã€Phoenix ã«ã¯ **Phoenix Channels** ã¨ã„ã† WebSocket ã‚’ç°¡å˜ã«æ‰±ãˆã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ã‚²ãƒ¼ãƒ ã®ãƒãƒƒãƒã¨ã‹ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¨ã‹ã‚’å®Ÿè£…ã™ã‚‹ã¨ãã€ãƒˆãƒ”ãƒƒã‚¯ãŒã©ã†ã“ã†ã¨ã‹ Pub/Sub ãŒã©ã†ã“ã†ã¨ã‹ã‚’ç”Ÿã® WebSocket ã‚’ä½¿ã£ã¦æ›¸ãã‚ã‘ã§ã™ãŒã€ã“ã‚Œã‚’ä½¿ãˆã°ä½•ã‚‚ã—ãªãã¦ã‚‚ã¨ã‚Šã‚ãˆãšä½¿ãˆã‚‹ Out of the Box ãªã‚‚ã®ãŒä½œã‚Œã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

ä»Šå›ã¯ã€ã“ã® **Phoenix Channels** ã‚’ä½¿ã£ã¦ã±ã±ã£ã¨ãƒãƒ£ãƒƒãƒˆã‚’ä½œã‚Šã¾ã™ã€‚

# ç’°å¢ƒ

- macOS 11.2.3
- Elixir 1.11.4
- Erlang/OTP 23
- Node.js 15.8.0
- Phoenix 1.5.8
- Godot 3.2.3

# 0. Erlang, Elixir, Phoenix ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ã  Elixir ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãªã„äººã¯ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ï¼
[asdf](https://github.com/asdf-vm/asdf) ã¨ã„ã†ã„ã‚ã‚“ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ç®¡ç†ã§ãã‚‹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒãŠã™ã™ã‚ã§ã™ã‚ˆ
Node, Deno, Python, Ruby, etc... ã‚‚ã¡ã‚ã‚“ä»Šå›ã¯ Elixir ã¨ Erlangã€‚
ä½•ã§ã‚‚ç®¡ç†ã§ãã¾ã™ã®ã§ nvm, rbenv, pyenv ç­‰ã¯å…¨ã¦ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†ã€‚

```sh
# install erlang & elixir with asdf
brew install asdf
asdf plugin add erlang https://github.com/asdf-vm/asdf-erlang.git
asdf plugin add elixir https://github.com/asdf-vm/asdf-elixir.git
asdf install erlang latest
asdf global erlang <installed-version>
asdf install elixir latest
asdf global elixir <installed-version>

# install phoneix
mix archive.install hex phx_new 1.5.8
```

# 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
mkdir godot_phx_websocket && cd godot_phx_websocket
touch project.godot
mix phx.new phx_ws_server --no-ecto  # ä»Šå›ã¯ DB ã„ã‚‰ãªã„ã®ã§ --no-ecto ã§

# ä¾å­˜ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (phx.new ã®å¾Œã«ã—ã¦ãŸã‚‰ä¸è¦)
cd phx_ws_server && mix deps.get
cd assets && npm install
```

# 2. GodotPhoenixClient ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

æœ‰å¿—ã®æ–¹ãŒä½œæˆã•ã‚ŒãŸã€Godot å°‚ç”¨ã® Phoenix Channels Client ãŒã‚ã‚Šã¾ã™ã®ã§ã€ãã‚Œã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä½¿ã„ã¾ã—ã‚‡ã†ï¼

ä½™è«‡ã§ã™ãŒã€[Phoenix Channels ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://hexdocs.pm/phoenix/channels.html#client-libraries) ã«ã‚‚ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒè¨˜è¼‰ã•ã‚Œã¦ã¾ã™ã€‚

[https://github.com/alfredbaudisch/GodotPhoenixChannels](https://github.com/alfredbaudisch/GodotPhoenixChannels) 

```bash
cd <project_root>
git clone https://github.com/alfredbaudisch/GodotPhoenixChannels.git
mv GodotPhoenixChannels/Phoenix  ./Phoenix
```

repogitory ã® `/Phoenix` ã¨ã„ã† dir ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® gdscript ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

é©å½“ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

(`/Demo` ã«å…¥ã£ã¦ã‚‹ãƒ‡ãƒ¢ã‚·ãƒ¼ãƒ³ã¯ä½¿ã„æ–¹ã®å‚è€ƒã«ãªã‚Šã¾ã™ï¼)

# 3. Channel ã®ä½œæˆ

```bash
cd ws_phx_server
mix phx.gen.channel Room
```

ã“ã‚Œã‚’ã‚„ã‚‹ã¨ã€ `ws_phx_server/lib/phx_ws_server_web/room_channel.ex` ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

`mix phx.gen.*` ã‚³ãƒãƒ³ãƒ‰ã¯ã€Rails ã® Scaffolding ã®ç²¾ç¥ã‚’å—ã‘ç¶™ãã‚³ãƒãƒ³ãƒ‰é›†ã§è‰²ã‚“ãªã‚‚ã®ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ãŒã€ã“ã‚Œã‚‚ãã®ä¸€ã¤ã€‚
è‡ªå‹•ç”Ÿæˆã¯ä¾¿åˆ©ã§ã™ãŒã€ä¸­èº«ã‚ã‹ã‚‰ãšã«ä½¿ã„ã¾ãã£ã¦ã‚‹ã¨å‰ã„äººã«æ€’ã‚‰ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€å¾Œã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã¡ã‚ƒã‚“ã¨èª­ã‚“ã§ãŠãã¾ã—ã‚‡ã†ã€‚

ã“ã®ãƒ‡ãƒ¢ã§ã¯ä¸­èº«ã‚’ã„ã˜ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä¸€å¿œè¦‹ã¦ãŠãã¨

```elixir
defmodule PhxWsServerWeb.RoomChannel do
  use PhxWsServerWeb, :channel

  @impl true
  def join("room:lobby", payload, socket) do
    if authorized?(payload) do
      {:ok, socket}
    else
      {:error, %{reason: "unauthorized"}}
    end
  end

  @impl true
  def handle_in("ping", payload, socket) do
    {:reply, {:ok, payload}, socket}
  end

  @impl true
  def handle_in("shout", payload, socket) do
    broadcast(socket, "shout", payload)
    {:noreply, socket}
  end

  defp authorized?(_payload) do
    true
  end
end
```

ä¸­èº«ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸‹ã®é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ãŒè¦‹ãˆã¾ã™ã€‚

- `join/3`
- `handle_in/3`
- `authorized?/1` : å¸¸ã« true = èªè¨¼ãªã—ã¨åŒã˜

å¼•æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã«ã‚ˆã‚Šã€åˆæœŸçŠ¶æ…‹ã§ã¯ `room:lobby` ã¨ã„ã† topic ã‚’ Pub/Sub ã§ãã¦ã€
`ping` ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹ payload ãŒã‚¨ã‚³ãƒ¼ã•ã‚Œã€`shout` ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹ã¨ payload ãŒ topic ã‚’è³¼èª­ã—ã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã•ã‚Œã‚‹ã€ã¨ã„ã†æŒ™å‹•ã«ãªã‚‹ã“ã¨ã‚’ç†è§£ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚(ã“ã‚Œã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€è‡ªåˆ†ã§å®Ÿè£…ã—ã¦å¢—ã‚„ã›ã‚‹)


# 4. Socket ã‹ã‚‰ Channel ã¸ã® Routing

Phoenix ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸã¨ãã«ã€æœ€åˆã‹ã‚‰å­˜åœ¨ã™ã‚‹ `lib/{project_web}/channels/user_socket.ex` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚

phonix project ã®ãƒ«ãƒ¼ãƒˆã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `ws://{url}/socket/websocket` ã®ãƒ«ãƒ¼ãƒˆãŒ ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«ã‚ã‚‹`PhxWsServerWeb.UserSocket` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```bash
> mix phx.routes

# Generated phx_ws_server app
#           page_path  GET  /                                      PhxWsServerWeb.PageController :index
# live_dashboard_path  GET  /dashboard                             Phoenix.LiveView.Plug :home
# live_dashboard_path  GET  /dashboard/:page                       Phoenix.LiveView.Plug :page
# live_dashboard_path  GET  /dashboard/:node/:page                 Phoenix.LiveView.Plug :page
#           websocket  WS   /live/websocket                        Phoenix.LiveView.Socket
#            longpoll  GET  /live/longpoll                         Phoenix.LiveView.Socket
#            longpoll  POST  /live/longpoll                         Phoenix.LiveView.Socket
#           websocket  WS   /socket/websocket                      PhxWsServerWeb.UserSocket
```

`UserSocket` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¥ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€æ›´ã« Channel ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€æ¬¡ã®ã‚ˆã†ã«æ›¸ãã¾ã—ã‚‡ã†ã€‚

```elixir
# phx_ws_server/lib/phx_ws_server_web/channels/user_socket.ex
defmodule PhxWsServerWeb.UserSocket do
  use Phoenix.Socket

  channel "room:*", PhxWsServerWeb.RoomChannel

	...
```

channel ãƒã‚¯ãƒ­ã‚’ã“ã®ã‚ˆã†ã«æ›¸ãã¨ã€ `room:` ã§å§‹ã¾ã‚‹ topic ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã™ã¹ã¦`PhxWsServerWeb.RoomChannel` ã«é€ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# 5. Chat ã‚·ãƒ¼ãƒ³ã®å®Ÿè£…

![](https://storage.googleapis.com/zenn-user-upload/xbtybve8wq2qc089gmkqg1928k8y)

UI ã®é…ç½®ã‚’èª¬æ˜ã™ã‚‹ã®ã¯ãªã‹ãªã‹é›£ã—ã„ã®ã§ã‚¹ã‚¯ã‚·ãƒ§ã§ (ç¬‘)

ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã™ã‚‹ãªã‚‰ã°ã€

- ç¸¦æ¨ªé…ç½®ã¯ `HBoxContainer`, `VBoxContainer` ã‚’ä½¿ã† (CSS FlexBox ã®è¦é ˜ã§)
- MailBox ã¯ `TextEdit` ãƒãƒ¼ãƒ‰ã‚’ Read only ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
    - Read only ãƒ¢ãƒ¼ãƒ‰ã ã¨æ–‡å­—è‰²ã¨èƒŒæ™¯ãŒã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã™ã‚‹ã®ã§ã€Theme, Custom Color ã§è‰²ã‚’å¤‰æ›´
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆãŒã—ã‚‡ã¼ã„ã®ã§ã€[Google Noto Sans](https://www.google.com/get/noto/#sans-lgc) ã‚’ãƒ•ã‚©ãƒ³ãƒˆã«è¨­å®š

# 6. Chat.gd ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè£…

å…ˆç¨‹ä½œã£ãŸã€Chat.tscn ã®ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¢ã‚¿ãƒƒãƒã€‚

socket ã®ãƒ›ã‚¹ãƒˆåã«ã¯ **localhost ã§ã¯ãªã 127.0.0.1 ã‚’æ›¸ãã¾ã™ã€‚**
ä½•æ•…ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€localhost ã ã¨ç¹‹ãŒã‚‰ãªã„ã§ã™(Godotã®å•é¡Œï¼Ÿ)

ã¨ã‚Šã‚ãˆãšä»¥ä¸‹ã‚’æ›¸ã

- å­ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‘ã‚¹ã‚’ç”¨æ„
- channel ç”¨ã®å¤‰æ•°ã‚’ç”¨æ„
- `_ready` ã§ socket ã® signal ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¥ç¶šã—ã€`socket.connect_socket()`ã‚’å®Ÿè¡Œ

```gdscript
extends Control

var socket := PhoenixSocket.new("ws://127.0.0.1:4000/socket", {params = {}})
var presence = PhoenixPresence.new()
var channel : PhoenixChannel = null

onready var join_button = $HBoxContainer/VBoxContainer/JoinButton
onready var ping_button = $HBoxContainer/VBoxContainer/PingButton
onready var shout_button = $HBoxContainer/VBoxContainer/ShoutButton
onready var name_edit = $HBoxContainer/VBoxContainer/NameInput/LineEdit
onready var text_edit = $HBoxContainer/VBoxContainer/TextEdit
onready var mail_box = $HBoxContainer/MailBox

func _ready():
    # æ¥ç¶šãŒå®Œäº†ã™ã‚‹ã¾ã§ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ãªã„ã‚ˆã†ã«ã™ã‚‹
    ping_button.disabled = true
    shout_button.disabled = true

    self.call_deferred("add_child", socket, true)
    socket.connect("on_open", self, "_on_Socket_open")
    socket.connect("on_error", self, "_on_Socket_error")
    socket.connect("on_close", self, "_on_Socket_close")
    socket.connect("on_connecting", self, "_on_Socket_connecting")
    presence.connect("on_join", self, "_on_Presence_join")
    presence.connect("on_leave", self, "_on_Presence_leave")
    socket.connect_socket()
    print(socket.get_is_connected())
```

æ¬¡ã«ã€ã‚·ã‚°ãƒŠãƒ«ã«å¯¾ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™

## Socket Signals

ç‰¹ã«ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ãªã„ã‘ã‚Œã©ã€æ¥ç¶šã®é€²è¡Œå…·åˆã‚’ print ã—ã¦ãŠãã€‚

```gdscript
# Socket Signal

func _on_Socket_open(params):
    print("open params: ", params)

func _on_Socket_error(error):
    print(error)

func _on_Socket_close():
    print("close")

func _on_Socket_connecting(is_connecting):
    if is_connecting:
        print("is_connecting ...")
    else:
        print("connected!")
```

## Channel Signals

PhoenixSocket ã®æ¥ç¶šãŒå®Œäº†ã—ãŸã‚‰ã€æ¬¡ã¯ãƒãƒ£ãƒ³ãƒãƒ«ã‚·ã‚°ãƒŠãƒ«ã¸ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’æ›¸ãã€‚

ä¸»ã«ã€ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ **MailBox** ã¸å‡ºåŠ›ã™ã‚‹ã®ãŒå½¹å‰²ã€‚

```gdscript
# Channel Signal

func _on_Channel_event(event_name, payload, status):
    print("_on_Channel_event:  ", event_name, ", ", status, ", ", payload)
    mail_box.text +=  "%s < %s \n" % [payload.name, payload.message]

func _on_Channel_join_result(status, result):
    print("_on_Channel_join_result:  ", status, ", ", result)
    if status == PhoenixChannel.STATUS.ok:
        mail_box.text += "- JOINED! -\n"
ã€€ã€€ã€€ã€€ã€€# ãƒãƒ£ãƒ³ãƒãƒ«ã¸å‚åŠ å‡ºæ¥ãŸã‚‰ã€ping ãƒœã‚¿ãƒ³ã¨ shout ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
        join_button.disabled = true
        ping_button.disabled = false
        shout_button.disabled = false

func _on_Channel_error(error):
    print("_on_Channel_error: " + str(error))

func _on_Channel_close(closed):
    print("_on_Channel_close: " + str(closed))
```

## Button Signals

UIã‹ã‚‰ã®å…¥åŠ›ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ã€‚

ä¸»ã«ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®å‚åŠ ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ãªã©ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

å…ˆç¨‹ä½œã£ãŸUIã®ã€**JoinButton**, **PingButton**, **ShoutButton**  ã® `pressed` signal ã‚’ Chat.gd ã«æ¥ç¶šã—ã¦ãŠã“ã†ã€‚

```gdscript
# Button Signal

func _on_JoinButton_pressed():
    print("join button pressed")
    if channel == null:
ã€€ã€€ã€€ã€€ã€€# æ¥ç¶šã•ã‚ŒãŸ socket ã‹ã‚‰ã€channelã‚’å–å¾—ã—å¤‰æ•°ã¸ã‚»ãƒƒãƒˆ
        channel = socket.channel("room:lobby", {}, presence) # room:lobby ãƒˆãƒ”ãƒƒã‚¯ã‚’ã‚»ãƒƒãƒˆ
        channel.join()
ã€€ã€€ã€€ã€€ã€€# å„ç¨® signal ã‚’ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æ¥ç¶š
        channel.connect("on_event", self, "_on_Channel_event")
        channel.connect("on_join_result", self, "_on_Channel_join_result")
        channel.connect("on_error", self, "_on_Channel_error")
        channel.connect("on_close", self, "_on_Channel_close")
    elif not channel.is_closed():
        channel.close()
        channel.join()
    elif channel.is_closed():
        channel.join()

func _on_PingButton_pressed():
    channel.push("ping", {"name": "server", "message" : "pong"})

func _on_ShoutButton_pressed():
    var message = text_edit.text
    var name = name_edit.text
    text_edit.text = ""
    if message == "": return
    channel.push("shout", {"name": name, "message": message})
```

# 7. Server ã¨ Client ã‚’èµ·å‹•

ã“ã“ã¾ã§ãã‚Œã°å®Œæˆã§ã™ï¼
ã‚ã¨ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•ã—ã¦ãƒãƒ£ãƒƒãƒˆã‚’è©¦ã—ã¾ã—ã‚‡ã†

server

```gdscirpt
cd phx_ws_server && mix phx.server
```

client (è¤‡æ•°èµ·å‹•ã—ã¦ã‚‚ã‚ˆã„)

```gdscript
alias godot="path/to/godot" # .zshrc ã«è¨­å®šã—ã¦ãŠãã¨æ—ã‚‹
godot -d Chat.tscn
```


https://youtu.be/o31bJ168bsM

# ã“ã®å®Ÿè£…ã®å•é¡Œç‚¹

- `room:lobby` ã—ã‹å‚åŠ ã§ããªã„
  - ä¸€éƒ¨å±‹ã ã‘ã€ã¤ã¾ã‚Šéƒ¨å±‹æ©Ÿèƒ½ãŒãªã„ã¨ã„ã†ã“ã¨
  - joiné–¢æ•°ã§`"room:" <> room_id` ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã‚’ä½¿ã†ã¨ã‚‚ã£ã¨ã™ã”ã„ã‚‰ã—ã„
- ping ã¨ shout ã—ã‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©ã—ã¦ãªã„
  - å€‹äººé€šè©±ã¨ã‹ã€ã‚¯ãƒ©ãƒ³é€šè©±ã¨ã‹ã‚‚ã£ã¨é¢ç™½ã„ã‚‚ã®ã‚’å®Ÿè£…ã§ãã‚‹ã‹ã‚‚
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒãªã„
  - print ã™ã‚‹ã ã‘  

# ã¾ã¨ã‚


- ç°¡å˜ãª WebSocket Chat ã‚’å®Ÿè£…ã—ãŸ
  - å¿œç”¨ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®é¡ã‚’å¢—ã‚„ã›ã°ã€ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ã‚„åŒæœŸé »åº¦ã®å°‘ãªã„ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãŒã§ãã‚‹ã§ã‚ã‚ã†
- Phoenix Channels ä½¿ã„å§‹ã‚ã‚‹ã®ã¯è¶…ç°¡å˜ã ã£ãŸ (Scaffold ã§ã‚³ãƒ¼ãƒ‰æ›¸ãé‡å°‘ãªã„)
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯ã€è¨€èªã«ã‚ˆã£ã¦ã¯ Phoenix Channels ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„ã“ã¨ã‚‚ã‚ã‚‹ã‹ã‚‚
  - Unityç”¨(https://github.com/Mazyod/PhoenixSharp)æ¢ã—ãŸã‚‰ã‚ã£ãŸ
- ç°¡å˜ã« ErlangVM ã®ãƒ‘ãƒ¯ãƒ¼ã‚’ä½¿ãˆã‚‹ã®ã§ã€çš†ã‚‚ Elixir ã‚„ã‚ã†ï¼

(è¿½è¨˜: è¿‘å¹´ã€ç­†è€…ã¯ä»•äº‹ã§Typescriptã‚’ä½¿ã£ã¦ã‚‹ã®ã§ã€ã“ã‚“ãªæ–‡ã‚’æ›¸ã„ãŸã‘ã©åˆ¥ã«Elixirã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã¨ã‹ã§ã¯ãªã„...)

## è£œè¶³

WebSocket ã¯ã€ TCP ä¸Šã«æˆã‚Šç«‹ã£ã¦ã„ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚ã‚Šã€é€šä¿¡ã®ä¿¡é ¼æ€§ã‚’æ‹…ä¿ã™ã‚‹ãŸã‚ã«é€šä¿¡é€Ÿåº¦ãŒçŠ ç‰²ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€å®Ÿéš›ã®æ‰€ã¯RealTime Multiplayerã«æœ€é©ã¨ã„ã†ã‚ã‘ã§ã¯ãªã„ã€‚

è¿½è¨˜:
~~ã¾ãŸã€Websocketã¯ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãŒé›£ã—ã„ã‚‰ã—ã„ã€‚~~
~~è‡ªåˆ†ã®ä½œã‚ã†ã¨ã™ã‚‹ã‚²ãƒ¼ãƒ ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒæœ¬å½“ã«å¿…è¦ã‹ã‚’è€ƒãˆã¦ã€ã‹ã‚ã‚Šã« Long Polling ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã‚‚ååˆ†ã‚ã‚Šã€‚~~

Phoenix PubSub ã‚’ä½¿ãˆã°ãƒãƒ«ãƒãƒãƒ¼ãƒ‰ã® Elixir ã‚¯ãƒ©ã‚¹ã‚¿åŒå£«ã§ Websocket ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡åŠã³ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã¯ç°¡å˜ã«ã§ãã‚‹ã€‚
Elixir ä½¿ã†ãªã‚‰ WebSocket åŠã³ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã¯ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã¨è€ƒãˆã¦ã„ã„ã€‚
